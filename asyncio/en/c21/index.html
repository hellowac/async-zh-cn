
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="hellowac-异步编程资料">
      
      
      
      
        <link rel="prev" href="../c20/">
      
      
        <link rel="next" href="../c22/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.4">
    
    
      
        <title>21. 非阻塞流 - async异步编程</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.bd3936ea.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="blue">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#21-非阻塞流" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
你当前浏览的版本已不是最新版本，
<a href="../../../..">
    <strong>点击这里</strong>
</a>查看最新版本的文档

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="async异步编程" class="md-header__button md-logo" aria-label="async异步编程" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            async异步编程
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              21. 非阻塞流
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hellowac/async-zh-cn" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    hellowac/async-zh-cn
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
    
  
  概览

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
    
  
  完整指南

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../runner/" class="md-tabs__link">
          
  
    
  
  其他

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="async异步编程" class="md-nav__button md-logo" aria-label="async异步编程" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    async异步编程
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hellowac/async-zh-cn" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    hellowac/async-zh-cn
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
    
      
        
          
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    概览
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            概览
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    完整指南
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            完整指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. 什么是异步编程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Asyncio 是什么
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. Asyncio 在什么时候使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. Python 中的协程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. 定义、创建和运行协程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. 事件循环是什么
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7. Asyncio 任务的创建和运行
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8. 使用和查询任务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c9/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9. 当前正在运行的任务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c10/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10. 同时运行多个协程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c11/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11. 在Group中管理多个协程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c12/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12. 等待任务的集合
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c13/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    13. 等待有时间限制的协程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c14/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    14. 防止任务被取消
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c15/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    15. 在 Asyncio 中运行阻塞任务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c16/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    16. 异步迭代器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c17/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    17. 异步生成器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c18/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    18. 异步上下文管理器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c19/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    19. 异步推导式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c20/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    20. 在非阻塞子进程中运行命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    21. 非阻塞流
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    21. 非阻塞流
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#211-asyncio-的流" class="md-nav__link">
    21.1 Asyncio 的流
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#212-如何打开一个连接" class="md-nav__link">
    21.2 如何打开一个连接
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#213-如何启动一个侦听服务" class="md-nav__link">
    21.3 如何启动一个侦听服务
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#214-如何使用-streamwriter-写入数据" class="md-nav__link">
    21.4 如何使用 StreamWriter 写入数据
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#215-如何使用-streamreader-读取数据" class="md-nav__link">
    21.5 如何使用 StreamReader 读取数据
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#216-如何关闭连接" class="md-nav__link">
    21.6 如何关闭连接
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c22/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    22. 检查网站状态的示例
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c23/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    23. Python Asyncio 常见错误
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c24/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    24. Python Asyncio 常见问题
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c25/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    25. 使用 Asyncio 的常见反对意见
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c26/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    26. 进一步阅读
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c27/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    27. 结论
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    其他
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            其他
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../runner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    如何使用async.Runner执行多个协程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../task_group/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    如何使用 asyncio.TaskGroup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cheat_sheet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Asyncio 表达式及API备忘录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api_mind_map/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    asyncio API 思维导图
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#211-asyncio-的流" class="md-nav__link">
    21.1 Asyncio 的流
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#212-如何打开一个连接" class="md-nav__link">
    21.2 如何打开一个连接
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#213-如何启动一个侦听服务" class="md-nav__link">
    21.3 如何启动一个侦听服务
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#214-如何使用-streamwriter-写入数据" class="md-nav__link">
    21.4 如何使用 StreamWriter 写入数据
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#215-如何使用-streamreader-读取数据" class="md-nav__link">
    21.5 如何使用 StreamReader 读取数据
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#216-如何关闭连接" class="md-nav__link">
    21.6 如何关闭连接
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="21-非阻塞流">21. 非阻塞流<a class="headerlink" href="#21-非阻塞流" title="Permanent link">&para;</a></h1>
<p><strong>21. Non-Blocking Streams</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">中文</label><label for="__tabbed_1_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>asyncio 的一个主要好处是能够使用非阻塞流。</p>
<p>让我们仔细看看。</p>
</div>
<div class="tabbed-block">
<p>A major benefit of asyncio is the ability to use non-blocking streams.</p>
<p>Let’s take a closer look.</p>
</div>
</div>
</div>
<h2 id="211-asyncio-的流">21.1 Asyncio 的流<a class="headerlink" href="#211-asyncio-的流" title="Permanent link">&para;</a></h2>
<p><strong>21.1 Asyncio Streams</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">中文</label><label for="__tabbed_2_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Asyncio 提供非阻塞 I/O 套接字编程。</p>
<p>这是通过流(streams)提供的。</p>
<blockquote>
<p>流(streams)是高级异步/等待就绪原语，可与网络连接一起使用。 流允许在不使用回调或低级协议和传输的情况下发送和接收数据。</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>可以打开提供对流写入器和流写入器的访问的套接字。</p>
<p>然后可以使用协程在流中写入和读取数据，并在适当的时候挂起。</p>
<p>完成后，可以关闭套接字。</p>
<p>异步流功能是低级的，这意味着必须手动实现所需的任何协议。</p>
<p>这可能包括常见的网络协议，例如：</p>
<ul>
<li>用于与 Web 服务器交互的 HTTP 或 HTTPS</li>
<li>用于与电子邮件服务器交互的 SMTP</li>
<li>用于与文件服务器交互的 FTP。</li>
</ul>
<p>这些流还可用于创建服务器来使用标准协议处理请求，或开发您自己的特定于应用程序的协议。</p>
<p>现在我们知道什么是异步流，让我们看看如何使用它们。</p>
</div>
<div class="tabbed-block">
<p>Asyncio provides non-blocking I/O socket programming.</p>
<p>This is provided via streams.</p>
<blockquote>
<p>Streams are high-level async/await-ready primitives to work with network connections. Streams allow sending and receiving data without using callbacks or low-level protocols and transports.</p>
<p>— ASYNCIO STREAMS</p>
</blockquote>
<p>Sockets can be opened that provide access to a stream writer and a stream writer.</p>
<p>Data can then be written and read from the stream using coroutines, suspending when appropriate.</p>
<p>Once finished, the socket can be closed.</p>
<p>The asyncio streams capability is low-level meaning that any protocols required must be implemented manually.</p>
<p>This might include common web protocols, such as:</p>
<ul>
<li>HTTP or HTTPS for interacting with web servers</li>
<li>SMTP for interacting with email servers</li>
<li>FTP for interacting with file servers.</li>
</ul>
<p>The streams can also be used to create a server to handle requests using a standard protocol, or to develop your own application-specific protocol.</p>
<p>Now that we know what asyncio streams are, let’s look at how to use them.</p>
</div>
</div>
</div>
<h2 id="212-如何打开一个连接">21.2 如何打开一个连接<a class="headerlink" href="#212-如何打开一个连接" title="Permanent link">&para;</a></h2>
<p><strong>21.2 How to Open a Connection</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">中文</label><label for="__tabbed_3_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>可以使用 <a href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.open_connection">asyncio.open_connection()</a> 函数打开 asyncio TCP 客户端套接字连接。</p>
<blockquote>
<p>建立网络连接并返回一对（reader、writer）对象。 返回的读取器和写入器对象是 StreamReader 和 StreamWriter 类的实例。</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>这是一个必须等待的协程，一旦套接字连接打开就会返回。</p>
<p>该函数返回一个 <strong>StreamReader</strong> 和 <strong>StreamWriter</strong> 对象，用于与套接字交互。</p>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 打开一个连接</span>
reader, writer <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>open_connection(<span style="color: #666666">...</span>)
</code></pre></div>
<p><strong>asyncio.open_connection()</strong> 函数需要许多参数来配置套接字连接。</p>
<p>两个必需的参数是主机和端口。</p>
<p>主机是一个字符串，指定要连接的服务器，例如域名或IP地址。</p>
<p>port 是套接字端口号，例如 HTTP 服务器为 80，HTTPS 服务器为 443，SMTP 为 23 等。</p>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 打开与 http 服务器的连接</span>
reader, writer <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>open_connection(<span style="color: #BA2121">&#39;www.google.com&#39;</span>, <span style="color: #666666">80</span>)
</code></pre></div>
<p>SSL 协议支持加密套接字连接。</p>
<p>最常见的例子可能是 HTTPS，它正在取代 HTTP。</p>
<p>这可以通过将“<strong>ssl</strong>”参数设置为<strong>True</strong>来实现。</p>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 打开与 https 服务器的连接</span>
reader, writer <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>open_connection(<span style="color: #BA2121">&#39;www.google.com&#39;</span>, <span style="color: #666666">443</span>, ssl<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
</code></pre></div>
</div>
<div class="tabbed-block">
<p>An asyncio TCP client socket connection can be opened using the <a href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.open_connection">asyncio.open_connection()</a> function.</p>
<blockquote>
<p>Establish a network connection and return a pair of (reader, writer) objects. The returned reader and writer objects are instances of StreamReader and StreamWriter classes.</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>This is a coroutine that must be awaited and will return once the socket connection is open.</p>
<p>The function returns a <strong>StreamReader</strong> and <strong>StreamWriter</strong> object for interacting with the socket.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># open a connection</span>
reader, writer <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>open_connection(<span style="color: #666666">...</span>)
</code></pre></div>
<p>The <strong>asyncio.open_connection()</strong> function takes many arguments in order to configure the socket connection.</p>
<p>The two required arguments are the host and the port.</p>
<p>The host is a string that specifies the server to connect to, such as a domain name or an IP address.</p>
<p>The port is the socket port number, such as 80 for HTTP servers, 443 for HTTPS servers, 23 for SMTP and so on.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># open a connection to an http server</span>
reader, writer <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>open_connection(<span style="color: #BA2121">&#39;www.google.com&#39;</span>, <span style="color: #666666">80</span>)
</code></pre></div>
<p>Encrypted socket connections are supported over the SSL protocol.</p>
<p>The most common example might be HTTPS which is replacing HTTP.</p>
<p>This can be achieved by setting the “<strong>ssl</strong>” argument to <strong>True</strong>.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># open a connection to an https server</span>
reader, writer <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>open_connection(<span style="color: #BA2121">&#39;www.google.com&#39;</span>, <span style="color: #666666">443</span>, ssl<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
</code></pre></div>
</div>
</div>
</div>
<h2 id="213-如何启动一个侦听服务">21.3 如何启动一个侦听服务<a class="headerlink" href="#213-如何启动一个侦听服务" title="Permanent link">&para;</a></h2>
<p><strong>21.3 How to Start a Server</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">中文</label><label for="__tabbed_4_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>可以使用 <a href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.start_server">asyncio.start_server()</a> 函数打开 <strong>asyncio TCP</strong> 服务器套接字。</p>
<blockquote>
<p>创建一个 TCP 服务器（套接字类型 <strong>SOCK_STREAM</strong>），侦听主机地址的端口。</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-eventloop.html">ASYNCIO EVENT LOOP</a></p>
</blockquote>
<p>这是一个必须等待的协程。</p>
<p>该函数返回一个代表正在运行的服务器的 <a href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.Server">asyncio.Server</a> 对象。</p>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 启动一个tcp服务器</span>
server <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>start_server(<span style="color: #666666">...</span>)
</code></pre></div>
<p>三个必需参数是回调函数、主机和端口。</p>
<p>回调函数是一个由名称指定的自定义函数，每次客户端连接到服务器时都会调用该函数。</p>
<blockquote>
<p>每当建立新的客户端连接时，都会调用 <code>client_connected_cb</code> 回调。 它接收一个（读取器(reader)，写入器(writer)）对作为两个参数，即 <strong>StreamReader</strong> 和 <strong>StreamWriter</strong> 类的实例。</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>主机是客户端指定连接的域名或IP地址。 <strong>port</strong> 是接收连接的套接字端口号，例如 <strong>FTP</strong> 为 <code>21</code>，<strong>HTTP</strong> 为 <code>80</code>。</p>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #3D7B7B; font-style: italic"># 处理连接</span>
<span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">handler</span>(reader, writer):
    <span style="color: #3D7B7B; font-style: italic"># ...</span>

<span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 启动一个服务器来接收http连接</span>
server <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>start_server(handler, <span style="color: #BA2121">&#39;127.0.0.1&#39;</span>, <span style="color: #666666">80</span>)
</code></pre></div>
</div>
<div class="tabbed-block">
<p>An asyncio TCP server socket can be opened using the <a href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.start_server">asyncio.start_server()</a> function.</p>
<blockquote>
<p>Create a TCP server (socket type SOCK_STREAM) listening on port of the host address.</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-eventloop.html">ASYNCIO EVENT LOOP</a></p>
</blockquote>
<p>This is a coroutine that must be awaited.</p>
<p>The function returns an <a href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.Server">asyncio.Server</a> object that represents the running server.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># start a tcp server</span>
server <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>start_server(<span style="color: #666666">...</span>)
</code></pre></div>
<p>The three required arguments are the callback function, the host, and the port.</p>
<p>The callback function is a custom function specified by name that will be called each time a client connects to the server.</p>
<blockquote>
<p>The client_connected_cb callback is called whenever a new client connection is established. It receives a (reader, writer) pair as two arguments, instances of the StreamReader and StreamWriter classes.</p>
<p>— ASYNCIO STREAMS</p>
</blockquote>
<p>The host is the domain name or IP address that clients will specify to connect. The port is the socket port number on which to receive connections, such as 21 for FTP or 80 for HTTP.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #3D7B7B; font-style: italic"># handle connections</span>
<span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">handler</span>(reader, writer):
    <span style="color: #3D7B7B; font-style: italic"># ...</span>

<span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># start a server to receive http connections</span>
server <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>start_server(handler, <span style="color: #BA2121">&#39;127.0.0.1&#39;</span>, <span style="color: #666666">80</span>)
</code></pre></div>
</div>
</div>
</div>
<h2 id="214-如何使用-streamwriter-写入数据">21.4 如何使用 StreamWriter 写入数据<a class="headerlink" href="#214-如何使用-streamwriter-写入数据" title="Permanent link">&para;</a></h2>
<p><strong>21.4 How to Write Data with the StreamWriter</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">中文</label><label for="__tabbed_5_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>我们可以使用 <a href="https://docs.python.org/3/library/asyncio-stream.html#streamwriter">asyncio.StreamWriter</a> 将数据写入套接字。</p>
<blockquote>
<p>表示一个 writer 对象，它提供 API 将数据写入 IO 流。</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>数据以字节形式写入。</p>
<p>可以使用 <a href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.StreamWriter.write">write()</a> 方法将字节数据写入套接字。</p>
<blockquote>
<p>该方法尝试立即将数据写入底层套接字。 如果失败，数据将在内部写入缓冲区中排队，直到可以发送。</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 写入字节数据</span>
writer<span style="color: #666666">.</span>write(byte_data)
</code></pre></div>
<p>或者，可以使用 <a href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.StreamWriter">writelines()</a> 写入组织成列表或可迭代的多“行”字节数据。 writelines) 方法。</p>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 写入字节数据行</span>
writer<span style="color: #666666">.</span>writelines(byte_lines)
</code></pre></div>
<p>这两种方法都不会写入数据块或挂起调用协程。</p>
<p>写入字节数据后，最好通过 <a href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.StreamWriter.drain">drain()</a> 方法排空套接字。</p>
<blockquote>
<p>等到合适的时候再继续写入流。</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>这是一个协程，将挂起调用者，直到字节已传输且套接字准备就绪。</p>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 写入字节数据</span>
writer<span style="color: #666666">.</span>write(byte_data)
<span style="color: #3D7B7B; font-style: italic"># 等待数据传输</span>
<span style="color: #008000; font-weight: bold">await</span> writer<span style="color: #666666">.</span>drain()
</code></pre></div>
</div>
<div class="tabbed-block">
<p>We can write data to the socket using an <a href="https://docs.python.org/3/library/asyncio-stream.html#streamwriter">asyncio.StreamWriter</a>.</p>
<blockquote>
<p>Represents a writer object that provides APIs to write data to the IO stream.</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>Data is written as bytes.</p>
<p>Byte data can be written to the socket using the <a href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.StreamWriter.write">write()</a> method.</p>
<blockquote>
<p>The method attempts to write the data to the underlying socket immediately. If that fails, the data is queued in an internal write buffer until it can be sent.</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># write byte data</span>
writer<span style="color: #666666">.</span>write(byte_data)
</code></pre></div>
<p>Alternatively, multiple “lines” of byte data organized into a list or iterable can be written using the <a href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.StreamWriter.writelines">writelines()</a> method.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># write lines of byte data</span>
writer<span style="color: #666666">.</span>writelines(byte_lines)
</code></pre></div>
<p>Neither method for writing data blocks or suspends the calling coroutine.</p>
<p>After writing byte data it is a good idea to drain the socket via the <a href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.StreamWriter.drain">drain()</a> method.</p>
<blockquote>
<p>Wait until it is appropriate to resume writing to the stream.</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>This is a coroutine and will suspend the caller until the bytes have been transmitted and the socket is ready.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># write byte data</span>
writer<span style="color: #666666">.</span>write(byte_data)
<span style="color: #3D7B7B; font-style: italic"># wait for data to be transmitted</span>
<span style="color: #008000; font-weight: bold">await</span> writer<span style="color: #666666">.</span>drain()
</code></pre></div>
</div>
</div>
</div>
<h2 id="215-如何使用-streamreader-读取数据">21.5 如何使用 StreamReader 读取数据<a class="headerlink" href="#215-如何使用-streamreader-读取数据" title="Permanent link">&para;</a></h2>
<p><strong>21.5 How to Read Data with the StreamReader</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">中文</label><label for="__tabbed_6_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>我们可以使用 <a href="https://docs.python.org/3/library/asyncio-stream.html#streamreader">asyncio.StreamReader</a> 从套接字读取数据。</p>
<blockquote>
<p>表示一个读取器对象，它提供 API 以从 IO 流读取数据。</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>数据以字节格式读取，因此字符串在使用之前可能需要进行编码。</p>
<p>所有读取方法都是必须等待的协程。</p>
<p>可以通过 <strong>read()</strong> 方法读取任意数量的字节，该方法将读取到文件末尾 (EOF)。</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 读取字节数据</span>
byte_data <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> reader<span style="color: #666666">.</span>read()
</code></pre></div>
<p>此外，可以通过“n”参数指定要读取的字节数。</p>
<blockquote>
<p>最多读取 n 个字节。 如果未提供 n 或设置为 -1，则读取直到 EOF 并返回所有读取的字节。</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>如果您知道下一个响应的预期字节数，这可能会有所帮助。</p>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 读取字节数据</span>
byte_data <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> reader<span style="color: #666666">.</span>read(n<span style="color: #666666">=100</span>)
</code></pre></div>
<p>可以使用 <strong>readline()</strong> 方法读取单行数据。</p>
<p>这将返回字节，直到遇到新行字符“\n”或 EOF。</p>
<blockquote>
<p>读取一行，其中“line”是以\n结尾的字节序列。 如果收到 EOF 但未找到 \n，则该方法返回部分读取的数据。 如果收到 EOF 并且内部缓冲区为空，则返回一个空字节对象。</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>这在阅读使用文本行操作的标准协议时很有帮助。</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 读取一行数据</span>
byte_line <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> reader<span style="color: #666666">.</span>readline()
</code></pre></div>
<p>此外，还有一个 <strong>readexactly()</strong> 方法用于读取确切的字节数，否则会引发异常，还有一个 <strong>readuntil()</strong> 方法将读取字节，直到读取字节形式的指定字符。</p>
</div>
<div class="tabbed-block">
<p>We can read data from the socket using an <a href="https://docs.python.org/3/library/asyncio-stream.html#streamreader">asyncio.StreamReader</a>.</p>
<blockquote>
<p>Represents a reader object that provides APIs to read data from the IO stream.</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>Data is read in byte format, therefore strings may need to be encoded before being used.</p>
<p>All read methods are coroutines that must be awaited.</p>
<p>An arbitrary number of bytes can be read via the read() method, which will read until the end of file (EOF).</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># read byte data</span>
byte_data <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> reader<span style="color: #666666">.</span>read()
</code></pre></div>
<p>Additionally, the number of bytes to read can be specified via the “n” argument.</p>
<blockquote>
<p>Read up to n bytes. If n is not provided, or set to -1, read until EOF and return all read bytes.</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>This may be helpful if you know the number of bytes expected from the next response.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># read byte data</span>
byte_data <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> reader<span style="color: #666666">.</span>read(n<span style="color: #666666">=100</span>)
</code></pre></div>
<p>A single line of data can be read using the readline() method.</p>
<p>This will return bytes until a new line character ‘\n’ is encountered, or EOF.</p>
<blockquote>
<p>Read one line, where “line” is a sequence of bytes ending with \n. If EOF is received and \n was not found, the method returns partially read data. If EOF is received and the internal buffer is empty, return an empty bytes object.</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>This is helpful when reading standard protocols that operate with lines of text.</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># read a line data</span>
byte_line <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> reader<span style="color: #666666">.</span>readline()
</code></pre></div>
<p>Additionally, there is a readexactly() method to read an exact number of bytes otherwise raise an exception, and a readuntil() that will read bytes until a specified character in byte form is read.</p>
</div>
</div>
</div>
<h2 id="216-如何关闭连接">21.6 如何关闭连接<a class="headerlink" href="#216-如何关闭连接" title="Permanent link">&para;</a></h2>
<p><strong>21.6 How to Close Connection</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">中文</label><label for="__tabbed_7_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>可以通过 <strong>asyncio.StreamWriter</strong> 关闭套接字。</p>
<p>可以调用 <strong>close()</strong> 方法来关闭套接字。</p>
<blockquote>
<p>该方法关闭流和底层套接字。</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>该方法不会阻塞。</p>
<p>例如：</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 关闭套接字</span>
writer<span style="color: #666666">.</span>close()
</code></pre></div>
<p>虽然 <strong>close()</strong> 方法不会阻塞，但我们可以等待套接字完全关闭后再继续。</p>
<p>这可以通过 <strong>wait_close()</strong> 方法来实现。</p>
<blockquote>
<p>等待流关闭。 应在 <strong>close()</strong> 之后调用以等待底层连接关闭。</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>这是一个可以等待的协程。</p>
<p>例如：</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 关闭套接字</span>
writer<span style="color: #666666">.</span>close()
<span style="color: #3D7B7B; font-style: italic"># 等待套接字关闭</span>
<span style="color: #008000; font-weight: bold">await</span> writer<span style="color: #666666">.</span>wait_closed()
</code></pre></div>
<p>我们可以通过 <strong>is_close()</strong> 方法检查套接字是否已关闭或正在关闭过程中。</p>
<p>例如：</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 检查套接字是否已关闭或正在关闭</span>
<span style="color: #008000; font-weight: bold">if</span> writer<span style="color: #666666">.</span>is_closing():
    <span style="color: #3D7B7B; font-style: italic"># ...</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>The socket can be closed via the asyncio.StreamWriter.</p>
<p>The close() method can be called which will close the socket.</p>
<blockquote>
<p>The method closes the stream and the underlying socket.</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>This method does not block.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># close the socket</span>
writer<span style="color: #666666">.</span>close()
</code></pre></div>
<p>Although the close() method does not block, we can wait for the socket to close completely before continuing on.</p>
<p>This can be achieved via the wait_closed() method.</p>
<blockquote>
<p>Wait until the stream is closed. Should be called after close() to wait until the underlying connection is closed.</p>
<p>— <a href="https://docs.python.org/3/library/asyncio-stream.html">ASYNCIO STREAMS</a></p>
</blockquote>
<p>This is a coroutine that can be awaited.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># close the socket</span>
writer<span style="color: #666666">.</span>close()
<span style="color: #3D7B7B; font-style: italic"># wait for the socket to close</span>
<span style="color: #008000; font-weight: bold">await</span> writer<span style="color: #666666">.</span>wait_closed()
</code></pre></div>
<p>We can check if the socket has been closed or is in the process of being closed via the is_closing() method.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># check if the socket is closed or closing</span>
<span style="color: #008000; font-weight: bold">if</span> writer<span style="color: #666666">.</span>is_closing():
    <span style="color: #3D7B7B; font-style: italic"># ...</span>
</code></pre></div>
</div>
</div>
</div>

  <hr>
<div class="md-source-file">
  <small>
    
      最后更新:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2024年9月4日</span>
      
        <br>
        创建日期:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2024年9月4日</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["header.autohide", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.path", "content.tabs.link", "content.code.copy", "content.tooltips", "navigation.indexes", "navigation.prune", "navigation.instant"], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.94c44541.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>