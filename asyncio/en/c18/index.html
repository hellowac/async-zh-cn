
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="hellowac-异步编程资料">
      
      
      
      
        <link rel="prev" href="../c17/">
      
      
        <link rel="next" href="../c19/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.4">
    
    
      
        <title>18. 异步上下文管理器 - async异步编程</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.bd3936ea.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="blue">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#18-异步上下文管理器" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
你当前浏览的版本已不是最新版本，
<a href="../../../..">
    <strong>点击这里</strong>
</a>查看最新版本的文档

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="async异步编程" class="md-header__button md-logo" aria-label="async异步编程" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            async异步编程
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              18. 异步上下文管理器
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hellowac/async-zh-cn" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    hellowac/async-zh-cn
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
    
  
  概览

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
    
  
  完整指南

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../runner/" class="md-tabs__link">
          
  
    
  
  其他

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="async异步编程" class="md-nav__button md-logo" aria-label="async异步编程" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    async异步编程
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hellowac/async-zh-cn" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    hellowac/async-zh-cn
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
    
      
        
          
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    概览
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            概览
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    完整指南
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            完整指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. 什么是异步编程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Asyncio 是什么
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. Asyncio 在什么时候使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. Python 中的协程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. 定义、创建和运行协程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. 事件循环是什么
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7. Asyncio 任务的创建和运行
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8. 使用和查询任务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c9/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9. 当前正在运行的任务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c10/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10. 同时运行多个协程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c11/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11. 在Group中管理多个协程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c12/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12. 等待任务的集合
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c13/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    13. 等待有时间限制的协程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c14/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    14. 防止任务被取消
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c15/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    15. 在 Asyncio 中运行阻塞任务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c16/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    16. 异步迭代器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c17/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    17. 异步生成器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    18. 异步上下文管理器
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    18. 异步上下文管理器
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#181-什么是异步上下文管理器" class="md-nav__link">
    18.1 什么是异步上下文管理器
  </a>
  
    <nav class="md-nav" aria-label="18.1 什么是异步上下文管理器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1811--上下文管理器" class="md-nav__link">
    18.1.1  上下文管理器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1812-异步上下文管理器" class="md-nav__link">
    18.1.2 异步上下文管理器
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#182-如何使用异步上下文管理器" class="md-nav__link">
    18.2 如何使用异步上下文管理器
  </a>
  
    <nav class="md-nav" aria-label="18.2 如何使用异步上下文管理器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1821-定义异步上下文管理器" class="md-nav__link">
    18.2.1 定义异步上下文管理器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1822-使用异步上下文管理器" class="md-nav__link">
    18.2.2 使用异步上下文管理器
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#183-异步上下文管理器和async-with的示例" class="md-nav__link">
    18.3 异步上下文管理器和“async with”的示例
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c19/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    19. 异步推导式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c20/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    20. 在非阻塞子进程中运行命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c21/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    21. 非阻塞流
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c22/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    22. 检查网站状态的示例
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c23/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    23. Python Asyncio 常见错误
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c24/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    24. Python Asyncio 常见问题
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c25/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    25. 使用 Asyncio 的常见反对意见
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c26/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    26. 进一步阅读
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../c27/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    27. 结论
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    其他
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            其他
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../runner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    如何使用async.Runner执行多个协程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../task_group/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    如何使用 asyncio.TaskGroup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cheat_sheet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Asyncio 表达式及API备忘录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api_mind_map/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    asyncio API 思维导图
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#181-什么是异步上下文管理器" class="md-nav__link">
    18.1 什么是异步上下文管理器
  </a>
  
    <nav class="md-nav" aria-label="18.1 什么是异步上下文管理器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1811--上下文管理器" class="md-nav__link">
    18.1.1  上下文管理器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1812-异步上下文管理器" class="md-nav__link">
    18.1.2 异步上下文管理器
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#182-如何使用异步上下文管理器" class="md-nav__link">
    18.2 如何使用异步上下文管理器
  </a>
  
    <nav class="md-nav" aria-label="18.2 如何使用异步上下文管理器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1821-定义异步上下文管理器" class="md-nav__link">
    18.2.1 定义异步上下文管理器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1822-使用异步上下文管理器" class="md-nav__link">
    18.2.2 使用异步上下文管理器
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#183-异步上下文管理器和async-with的示例" class="md-nav__link">
    18.3 异步上下文管理器和“async with”的示例
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="18-异步上下文管理器">18. 异步上下文管理器<a class="headerlink" href="#18-异步上下文管理器" title="Permanent link">&para;</a></h1>
<p><strong>18. Asynchronous Context Managers</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">中文</label><label for="__tabbed_1_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>上下文管理器是一个 Python 结构，它提供了一个类似 try-finally 的环境，具有一致的接口和方便的语法，例如 通过“with”表达。</p>
<p>它通常与资源一起使用，确保资源在使用完毕后始终关闭或释放，无论资源的使用是否成功或因异常而失败。</p>
<p>Asyncio 允许我们开发异步上下文管理器。</p>
<p>我们可以通过定义一个实现 <strong>__aenter__()</strong> 和 <strong>__aexit__()</strong> 方法的对象作为协程来在 asyncio 程序中创建和使用异步上下文管理器。</p>
<p>让我们仔细看看。</p>
</div>
<div class="tabbed-block">
<p>A context manager is a Python construct that provides a try-finally like environment with a consistent interface and handy syntax, e.g. via the “with” expression.</p>
<p>It is commonly used with resources, ensuring the resource is always closed or released after we are finished with it, regardless of whether the usage of the resources was successful or failed with an exception.</p>
<p>Asyncio allows us to develop asynchronous context managers.</p>
<p>We can create and use asynchronous context managers in asyncio programs by defining an object that implements the <strong>__aenter__()</strong> and <strong>__aexit__()</strong> methods as coroutines.</p>
<p>Let’s take a closer look.</p>
</div>
</div>
</div>
<h2 id="181-什么是异步上下文管理器">18.1 什么是异步上下文管理器<a class="headerlink" href="#181-什么是异步上下文管理器" title="Permanent link">&para;</a></h2>
<p><strong>18.1 What is an Asynchronous Context Manager</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">中文</label><label for="__tabbed_2_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>异步上下文管理器是一个实现 <strong>__aenter__()</strong> 和 <strong>__aexit__()</strong> 方法的 Python 对象。</p>
<p>在我们深入了解异步上下文管理器的细节之前，让我们回顾一下经典的上下文管理器。</p>
</div>
<div class="tabbed-block">
<p>An asynchronous context manager is a Python object that implements the <strong>__aenter__()</strong> and <strong>__aexit_ _()</strong> methods.</p>
<p>Before we dive into the details of asynchronous context managers, let’s review classical context managers.</p>
</div>
</div>
</div>
<h3 id="1811--上下文管理器">18.1.1  上下文管理器<a class="headerlink" href="#1811--上下文管理器" title="Permanent link">&para;</a></h3>
<p><strong>18.1.1  Context Manager</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">中文</label><label for="__tabbed_3_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>上下文管理器是一个实现 __enter__() 和 __exit__() 方法的 Python 对象。</p>
<blockquote>
<p>上下文管理器是一个对象，它定义执行 with 语句时要建立的运行时上下文。 上下文管理器处理执行代码块所需的运行时上下文的进入和退出。</p>
<p>— <a href="https://docs.python.org/3/reference/datamodel.html#context-managers">WITH STATEMENT CONTEXT MANAGERS</a></p>
</blockquote>
<ul>
<li>__enter__() 方法定义在块开始时发生的情况，例如打开或准备资源，如文件、套接字或线程池。</li>
<li>__exit__() 方法定义退出块时会发生什么，例如关闭准备好的资源。</li>
</ul>
<blockquote>
<p>上下文管理器的典型用途包括保存和恢复各种全局状态、锁定和解锁资源、关闭打开的文件等。</p>
<p>— <a href="https://docs.python.org/3/reference/datamodel.html#context-managers">WITH STATEMENT CONTEXT MANAGERS</a></p>
</blockquote>
<p>上下文管理器通过“with”表达式使用。</p>
<p>通常，上下文管理器对象是在“with”表达式的开头创建的，并且自动调用 __enter__() 方法。 内容的主体通过指定的上下文管理器对象使用资源，然后当块正常或通过异常退出时，自动调用 __aexit__() 方法。</p>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 打开上下文管理器</span>
<span style="color: #008000; font-weight: bold">with</span> ContextManager() <span style="color: #008000; font-weight: bold">as</span> manager:
    <span style="color: #3D7B7B; font-style: italic"># ...</span>
<span style="color: #3D7B7B; font-style: italic"># 自动关闭</span>
This mirrors a <span style="color: #008000; font-weight: bold">try</span><span style="color: #666666">-</span><span style="color: #008000; font-weight: bold">finally</span> expression<span style="color: #666666">.</span>
</code></pre></div>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 创建对象</span>
manager <span style="color: #666666">=</span> ContextManager()
<span style="color: #008000; font-weight: bold">try</span>:
    manager<span style="color: #666666">.</span><span style="color: #0000FF">__enter__</span>()
    <span style="color: #3D7B7B; font-style: italic"># ...</span>
<span style="color: #008000; font-weight: bold">finally</span>:
    manager<span style="color: #666666">.</span><span style="color: #0000FF">__exit__</span>()
</code></pre></div>
<p>接下来，让我们看一下异步上下文管理器。</p>
</div>
<div class="tabbed-block">
<p>A context manager is a Python object that implements the __enter__() and __exit__() methods.</p>
<blockquote>
<p>A context manager is an object that defines the runtime context to be established when executing a with statement. The context manager handles the entry into, and the exit from, the desired runtime context for the execution of the block of code.</p>
<p>— <a href="https://docs.python.org/3/reference/datamodel.html#context-managers">WITH STATEMENT CONTEXT MANAGERS</a></p>
</blockquote>
<ul>
<li>The __enter__() method defines what happens at the beginning of a block, such as opening or preparing resources, like a file, socket or thread pool.</li>
<li>The __exit__() method defines what happens when the block is exited, such as closing a prepared resource.</li>
</ul>
<blockquote>
<p>Typical uses of context managers include saving and restoring various kinds of global state, locking and unlocking resources, closing opened files, etc.</p>
<p>— <a href="https://docs.python.org/3/reference/datamodel.html#context-managers">WITH STATEMENT CONTEXT MANAGERS</a></p>
</blockquote>
<p>A context manager is used via the “with” expression.</p>
<p>Typically the context manager object is created in the beginning of the “with” expression and the __enter__() method is called automatically. The body of the content makes use of the resource via the named context manager object, then the __aexit__() method is called automatically when the block is exited, normally or via an exception.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># open a context manager</span>
<span style="color: #008000; font-weight: bold">with</span> ContextManager() <span style="color: #008000; font-weight: bold">as</span> manager:
    <span style="color: #3D7B7B; font-style: italic"># ...</span>
<span style="color: #3D7B7B; font-style: italic"># closed automatically</span>
This mirrors a <span style="color: #008000; font-weight: bold">try</span><span style="color: #666666">-</span><span style="color: #008000; font-weight: bold">finally</span> expression<span style="color: #666666">.</span>
</code></pre></div>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># create the object</span>
manager <span style="color: #666666">=</span> ContextManager()
<span style="color: #008000; font-weight: bold">try</span>:
    manager<span style="color: #666666">.</span><span style="color: #0000FF">__enter__</span>()
    <span style="color: #3D7B7B; font-style: italic"># ...</span>
<span style="color: #008000; font-weight: bold">finally</span>:
    manager<span style="color: #666666">.</span><span style="color: #0000FF">__exit__</span>()
</code></pre></div>
<p>Next, let’s take a look at asynchronous context managers.</p>
</div>
</div>
</div>
<h3 id="1812-异步上下文管理器">18.1.2 异步上下文管理器<a class="headerlink" href="#1812-异步上下文管理器" title="Permanent link">&para;</a></h3>
<p><strong>18.1.2  Asynchronous Context Manager</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">中文</label><label for="__tabbed_4_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>异步上下文管理器在“<a href="https://peps.python.org/pep-0492/">PEP 492 – 具有异步和等待语法的协程</a>”中引入。</p>
<p>它们提供了一个上下文管理器，可以在进入和退出时暂停。</p>
<blockquote>
<p>异步上下文管理器是能够在其 __aenter__ 和 __aexit__ 方法中暂停执行的上下文管理器。</p>
<p>— <a href="https://docs.python.org/3/reference/datamodel.html#asynchronous-context-managers">ASYNCHRONOUS CONTEXT MANAGERS</a></p>
</blockquote>
<p><strong>__aenter__</strong> 和 <strong>__aexit__</strong> 方法被定义为协程并由调用者等待。</p>
<p>这是使用“<strong>async with</strong>”表达式来实现的。</p>
<p>您可以在教程中了解有关“<strong>async with</strong>”表达式的更多信息：</p>
<ul>
<li><a href="https://superfastpython.com/asyncio-async-with/">Asyncio 异步是什么</a></li>
</ul>
<p>因此，异步上下文管理器只能在 asyncio 程序中使用，例如在调用协程中。</p>
<p>什么是“异步”</p>
<p>“<strong>async with</strong>”表达式用于创建和使用异步上下文管理器。</p>
<p>它是“<strong>with</strong>”表达式的扩展，用于 asyncio 程序中的协程。</p>
<p>“<strong>async with</strong>”表达式就像用于上下文管理器的“<strong>with</strong>”表达式一样，只不过它允许在协程中使用异步上下文管理器。</p>
<p>为了更好地理解“<strong>async with</strong>”，让我们仔细看看异步上下文管理器。</p>
<p>async with 表达式允许协程创建和使用上下文管理器的异步版本。</p>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 创建并使用异步上下文管理器</span>
<span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">with</span> AsyncContextManager() <span style="color: #008000; font-weight: bold">as</span> manager:
    <span style="color: #3D7B7B; font-style: italic"># ...</span>
</code></pre></div>
<p>这相当于：</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 创建或进入异步上下文管理器</span>
manager <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> AsyncContextManager()
<span style="color: #008000; font-weight: bold">try</span>:
    <span style="color: #3D7B7B; font-style: italic"># ...</span>
<span style="color: #008000; font-weight: bold">finally</span>:
    <span style="color: #3D7B7B; font-style: italic"># 关闭或退出上下文管理器</span>
    <span style="color: #008000; font-weight: bold">await</span> manager<span style="color: #666666">.</span>close()
</code></pre></div>
<p>请注意，我们实现的模式与传统上下文管理器几乎相同，只是创建和关闭上下文管理器涉及等待协程。</p>
<p>这会暂停当前协程的执行，安排一个新的协程并等待其完成。</p>
<p>因此，异步上下文管理器必须实现 <strong>__aenter__()</strong> 和 <strong>__aexit__()</strong> 方法，这些方法必须通过 async def 表达式定义。 这使得它们本身成为协程，也可能等待。</p>
</div>
<div class="tabbed-block">
<p>Asynchronous context managers were introduced in “<a href="https://peps.python.org/pep-0492/">PEP 492 – Coroutines with async and await syntax</a>“.</p>
<p>They provide a context manager that can be suspended when entering and exiting.</p>
<blockquote>
<p>An asynchronous context manager is a context manager that is able to suspend execution in its __aenter__ and __aexit__ methods.</p>
<p>— ASYNCHRONOUS CONTEXT MANAGERS</p>
</blockquote>
<p>The __aenter__ and __aexit__ methods are defined as coroutines and are awaited by the caller.</p>
<p>This is achieved using the “<strong>async with</strong>” expression.</p>
<p>You can learn more about the “<strong>async with</strong>” expression in the tutorial:</p>
<ul>
<li><a href="https://superfastpython.com/asyncio-async-with/">What is Asyncio async with</a></li>
</ul>
<p>As such, asynchronous context managers can only be used within asyncio programs, such as within calling coroutines.</p>
<p>What is “async with”</p>
<p>The “<strong>async with</strong>” expression is for creating and using asynchronous context managers.</p>
<p>It is an extension of the “<strong>with</strong>” expression for use in coroutines within asyncio programs.</p>
<p>The “<strong>async with</strong>” expression is just like the “<strong>with</strong>” expression used for context managers, except it allows asynchronous context managers to be used within coroutines.</p>
<p>In order to better understand “<strong>async with</strong>“, let’s take a closer look at asynchronous context managers.</p>
<p>The async with expression allows a coroutine to create and use an asynchronous version of a context manager.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># create and use an asynchronous context manager</span>
<span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">with</span> AsyncContextManager() <span style="color: #008000; font-weight: bold">as</span> manager:
    <span style="color: #3D7B7B; font-style: italic"># ...</span>
</code></pre></div>
<p>This is equivalent to something like:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># create or enter the async context manager</span>
manager <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">await</span> AsyncContextManager()
<span style="color: #008000; font-weight: bold">try</span>:
    <span style="color: #3D7B7B; font-style: italic"># ...</span>
<span style="color: #008000; font-weight: bold">finally</span>:
    <span style="color: #3D7B7B; font-style: italic"># close or exit the context manager</span>
    <span style="color: #008000; font-weight: bold">await</span> manager<span style="color: #666666">.</span>close()
</code></pre></div>
<p>Notice that we are implementing much the same pattern as a traditional context manager, except that creating and closing the context manager involve awaiting coroutines.</p>
<p>This suspends the execution of the current coroutine, schedules a new coroutine and waits for it to complete.</p>
<p>As such an asynchronous context manager must implement the <strong>__aenter__()</strong> and <strong>__aexit__()</strong> methods that must be defined via the async def expression. This makes them coroutines themselves which may also await.</p>
</div>
</div>
</div>
<h2 id="182-如何使用异步上下文管理器">18.2 如何使用异步上下文管理器<a class="headerlink" href="#182-如何使用异步上下文管理器" title="Permanent link">&para;</a></h2>
<p><strong>18.2 How to Use Asynchronous Context Managers</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">中文</label><label for="__tabbed_5_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>在本节中，我们将探讨如何在 asyncio 程序中定义、创建和使用异步上下文管理器。</p>
</div>
<div class="tabbed-block">
<p>In this section, we will explore how we can define, create, and use asynchronous context managers in our asyncio programs.</p>
</div>
</div>
</div>
<h3 id="1821-定义异步上下文管理器">18.2.1 定义异步上下文管理器<a class="headerlink" href="#1821-定义异步上下文管理器" title="Permanent link">&para;</a></h3>
<p><strong>18.2.1 Define an Asynchronous Context Manager</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">中文</label><label for="__tabbed_6_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>我们可以将异步上下文管理器定义为实现 <strong>__aenter__()</strong> 和 <strong>__aexit__()</strong> 方法的 Python 对象。</p>
<p>重要的是，这两种方法都必须使用“<strong>async def</strong>”定义为协程，因此必须返回可等待对象。</p>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #3D7B7B; font-style: italic"># 定义异步上下文管理器</span>
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">AsyncContextManager</span>:
    <span style="color: #3D7B7B; font-style: italic"># 进入异步上下文管理器</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__aenter__</span>(<span style="color: #008000">self</span>):
        <span style="color: #3D7B7B; font-style: italic"># 报告消息</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">&#39;&gt;entering the context manager&#39;</span>)

    <span style="color: #3D7B7B; font-style: italic"># 退出异步上下文管理器</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__aexit__</span>(<span style="color: #008000">self</span>, exc_type, exc, tb):
        <span style="color: #3D7B7B; font-style: italic"># 报告消息</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">&#39;&gt;exiting the context manager&#39;</span>)
</code></pre></div>
<p>因为每个方法都是协程，所以它们本身可能等待协程或任务。</p>
<p>例如:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #3D7B7B; font-style: italic"># 定义异步上下文管理器</span>
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">AsyncContextManager</span>:
    <span style="color: #3D7B7B; font-style: italic"># 进入异步上下文管理器</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__aenter__</span>(<span style="color: #008000">self</span>):
        <span style="color: #3D7B7B; font-style: italic"># 报告消息</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">&#39;&gt;entering the context manager&#39;</span>)
        <span style="color: #3D7B7B; font-style: italic"># 暂时阻塞</span>
        <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>sleep(<span style="color: #666666">0.5</span>)

    <span style="color: #3D7B7B; font-style: italic"># 退出异步上下文管理器</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__aexit__</span>(<span style="color: #008000">self</span>, exc_type, exc, tb):
        <span style="color: #3D7B7B; font-style: italic"># 报告消息</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">&#39;&gt;exiting the context manager&#39;</span>)
        <span style="color: #3D7B7B; font-style: italic"># 暂时阻塞</span>
        <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>sleep(<span style="color: #666666">0.5</span>)
</code></pre></div>
</div>
<div class="tabbed-block">
<p>We can define an asynchronous context manager as a Python object that implements the <strong>__aenter__()</strong> and <strong>__aexit__()</strong> methods.</p>
<p>Importantly, both methods must be defined as coroutines using the “<strong>async def</strong>” and therefore must return awaitables.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #3D7B7B; font-style: italic"># define an asynchronous context manager</span>
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">AsyncContextManager</span>:
    <span style="color: #3D7B7B; font-style: italic"># enter the async context manager</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__aenter__</span>(<span style="color: #008000">self</span>):
        <span style="color: #3D7B7B; font-style: italic"># report a message</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">&#39;&gt;entering the context manager&#39;</span>)

    <span style="color: #3D7B7B; font-style: italic"># exit the async context manager</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__aexit__</span>(<span style="color: #008000">self</span>, exc_type, exc, tb):
        <span style="color: #3D7B7B; font-style: italic"># report a message</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">&#39;&gt;exiting the context manager&#39;</span>)
</code></pre></div>
<p>Because each of the methods are coroutines, they may themselves await coroutines or tasks.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #3D7B7B; font-style: italic"># define an asynchronous context manager</span>
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">AsyncContextManager</span>:
    <span style="color: #3D7B7B; font-style: italic"># enter the async context manager</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__aenter__</span>(<span style="color: #008000">self</span>):
        <span style="color: #3D7B7B; font-style: italic"># report a message</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">&#39;&gt;entering the context manager&#39;</span>)
        <span style="color: #3D7B7B; font-style: italic"># block for a moment</span>
        <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>sleep(<span style="color: #666666">0.5</span>)

    <span style="color: #3D7B7B; font-style: italic"># exit the async context manager</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__aexit__</span>(<span style="color: #008000">self</span>, exc_type, exc, tb):
        <span style="color: #3D7B7B; font-style: italic"># report a message</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">&#39;&gt;exiting the context manager&#39;</span>)
        <span style="color: #3D7B7B; font-style: italic"># block for a moment</span>
        <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>sleep(<span style="color: #666666">0.5</span>)
</code></pre></div>
</div>
</div>
</div>
<h3 id="1822-使用异步上下文管理器">18.2.2 使用异步上下文管理器<a class="headerlink" href="#1822-使用异步上下文管理器" title="Permanent link">&para;</a></h3>
<p><strong>18.2.2 Use an Asynchronous Context Manager</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">中文</label><label for="__tabbed_7_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>异步上下文管理器通过“<strong>async with</strong>”表达式使用。</p>
<p>这将自动等待进入和退出协程，并根据需要暂停调用协程。</p>
<p>例如：</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># 使用异步上下文管理器</span>
<span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">with</span> AsyncContextManager() <span style="color: #008000; font-weight: bold">as</span> manager:
    <span style="color: #3D7B7B; font-style: italic"># ...</span>
</code></pre></div>
<p>因此，“<strong>async with</strong>”表达式和异步上下文管理器更一般地只能在 asyncio 程序中使用，例如在协程中。</p>
<p>现在我们知道如何使用异步上下文管理器，让我们看一个有效的示例。</p>
</div>
<div class="tabbed-block">
<p>An asynchronous context manager is used via the “<strong>async with</strong>” expression.</p>
<p>This will automatically await the enter and exit coroutines, suspending the calling coroutine as needed.</p>
<p>For example:</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">...</span>
<span style="color: #3D7B7B; font-style: italic"># use an asynchronous context manager</span>
<span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">with</span> AsyncContextManager() <span style="color: #008000; font-weight: bold">as</span> manager:
    <span style="color: #3D7B7B; font-style: italic"># ...</span>
</code></pre></div>
<p>As such, the “<strong>async with</strong>” expression and asynchronous context managers more generally can only be used within asyncio programs, such as within coroutines.</p>
<p>Now that we know how to use asynchronous context managers, let’s look at a worked example.</p>
</div>
</div>
</div>
<h2 id="183-异步上下文管理器和async-with的示例">18.3 异步上下文管理器和“async with”的示例<a class="headerlink" href="#183-异步上下文管理器和async-with的示例" title="Permanent link">&para;</a></h2>
<p><strong>18.3 Example of an Asynchronous Context Manager and “async with”</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:2"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><input id="__tabbed_8_2" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">中文</label><label for="__tabbed_8_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>我们可以通过“<strong>async with</strong>”表达式探索如何使用异步上下文管理器。</p>
<p>在此示例中，我们将更新上面的示例以正常方式使用上下文管理器。</p>
<p>我们将使用“<strong>async with</strong>”表达式，并在一行中创建并输入上下文管理器。 这将自动等待输入方法。</p>
<p>然后我们可以在内部块中使用管理器。 在这种情况下，我们只会报告一条消息。</p>
<p>退出内部块将自动等待上下文管理器的退出方法。</p>
<p>将此示例与前面的示例进行对比，可以看出“<strong>async with</strong>”表达式在 asyncio 程序中为我们带来了多大的负担。</p>
<p>下面列出了完整的示例。</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #3D7B7B; font-style: italic"># SuperFastPython.com</span>
<span style="color: #3D7B7B; font-style: italic"># 通过 async with 实现异步上下文管理器的示例</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">asyncio</span>

<span style="color: #3D7B7B; font-style: italic"># 定义异步上下文管理器</span>
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">AsyncContextManager</span>:
    <span style="color: #3D7B7B; font-style: italic"># 进入异步上下文管理器</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__aenter__</span>(<span style="color: #008000">self</span>):
        <span style="color: #3D7B7B; font-style: italic"># 报告消息</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">&#39;&gt;entering the context manager&#39;</span>)
        <span style="color: #3D7B7B; font-style: italic"># 暂时阻塞</span>
        <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>sleep(<span style="color: #666666">0.5</span>)

    <span style="color: #3D7B7B; font-style: italic"># 退出异步上下文管理器</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__aexit__</span>(<span style="color: #008000">self</span>, exc_type, exc, tb):
        <span style="color: #3D7B7B; font-style: italic"># 报告消息</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">&#39;&gt;exiting the context manager&#39;</span>)
        <span style="color: #3D7B7B; font-style: italic"># 暂时阻塞</span>
        <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>sleep(<span style="color: #666666">0.5</span>)

<span style="color: #3D7B7B; font-style: italic"># 定义一个简单的协程</span>
<span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">custom_coroutine</span>():
    <span style="color: #3D7B7B; font-style: italic"># 创建并使用异步上下文管理器</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">with</span> AsyncContextManager() <span style="color: #008000; font-weight: bold">as</span> manager:
        <span style="color: #3D7B7B; font-style: italic"># 报告结果</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">f&#39;within the manager&#39;</span>)

<span style="color: #3D7B7B; font-style: italic"># 启动异步程序</span>
asyncio<span style="color: #666666">.</span>run(custom_coroutine())
</code></pre></div>
<p>运行该示例首先创建 <strong>main()</strong> 协程，并将其用作 asyncio 程序的入口点。</p>
<p><strong>main()</strong> 协程运行并在“<strong>async with</strong>”表达式中创建 <strong>AsyncContextManager</strong> 类的实例。</p>
<p>该表达式自动调用 Enter 方法并等待协程。 报告一条消息，协程阻塞片刻。</p>
<p><strong>main()</strong> 协程恢复并执行上下文管理器的主体，打印一条消息。</p>
<p>该块退出并自动等待上下文管理器的退出方法，报告消息并休眠一会儿。</p>
<p>这突出显示了 asyncio 程序中异步上下文管理器的正常使用模式。</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">&gt;</span>entering the context manager
within the manager
<span style="color: #666666">&gt;</span>exiting the context manager
</code></pre></div>
<p>您可以在教程中了解有关异步上下文管理器的更多信息：</p>
<ul>
<li><a href="https://superfastpython.com/asynchronous-context-manager/">Asynchronous Context Managers in Python</a></li>
</ul>
<p>接下来，我们将探索异步推导式。</p>
</div>
<div class="tabbed-block">
<p>We can explore how to use an asynchronous context manager via the “<strong>async with</strong>” expression.</p>
<p>In this example, we will update the above example to use the context manager in a normal manner.</p>
<p>We will use an “<strong>async with</strong>” expression and on one line, create and enter the context manager. This will automatically await the enter method.</p>
<p>We can then make use of the manager within the inner block. In this case, we will just report a message.</p>
<p>Exiting the inner block will automatically await the exit method of the context manager.</p>
<p>Contrasting this example with the previous example shows how much heavy lifting the “<strong>async with</strong>” expression does for us in an asyncio program.</p>
<p>The complete example is listed below.</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #3D7B7B; font-style: italic"># SuperFastPython.com</span>
<span style="color: #3D7B7B; font-style: italic"># example of an asynchronous context manager via async with</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">asyncio</span>

<span style="color: #3D7B7B; font-style: italic"># define an asynchronous context manager</span>
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">AsyncContextManager</span>:
    <span style="color: #3D7B7B; font-style: italic"># enter the async context manager</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__aenter__</span>(<span style="color: #008000">self</span>):
        <span style="color: #3D7B7B; font-style: italic"># report a message</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">&#39;&gt;entering the context manager&#39;</span>)
        <span style="color: #3D7B7B; font-style: italic"># block for a moment</span>
        <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>sleep(<span style="color: #666666">0.5</span>)

    <span style="color: #3D7B7B; font-style: italic"># exit the async context manager</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__aexit__</span>(<span style="color: #008000">self</span>, exc_type, exc, tb):
        <span style="color: #3D7B7B; font-style: italic"># report a message</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">&#39;&gt;exiting the context manager&#39;</span>)
        <span style="color: #3D7B7B; font-style: italic"># block for a moment</span>
        <span style="color: #008000; font-weight: bold">await</span> asyncio<span style="color: #666666">.</span>sleep(<span style="color: #666666">0.5</span>)

<span style="color: #3D7B7B; font-style: italic"># define a simple coroutine</span>
<span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">custom_coroutine</span>():
    <span style="color: #3D7B7B; font-style: italic"># create and use the asynchronous context manager</span>
    <span style="color: #008000; font-weight: bold">async</span> <span style="color: #008000; font-weight: bold">with</span> AsyncContextManager() <span style="color: #008000; font-weight: bold">as</span> manager:
        <span style="color: #3D7B7B; font-style: italic"># report the result</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">f&#39;within the manager&#39;</span>)

<span style="color: #3D7B7B; font-style: italic"># start the asyncio program</span>
asyncio<span style="color: #666666">.</span>run(custom_coroutine())
</code></pre></div>
<p>Running the example first creates the <strong>main()</strong> coroutine and uses it as the entry point into the asyncio program.</p>
<p>The <strong>main()</strong> coroutine runs and creates an instance of our <strong>AsyncContextManager</strong> class in an “<strong>async with</strong>” expression.</p>
<p>This expression automatically calls the enter method and awaits the coroutine. A message is reported and the coroutine blocks for a moment.</p>
<p>The <strong>main()</strong> coroutine resumes and executes the body of the context manager, printing a message.</p>
<p>The block is exited and the exit method of the context manager is awaited automatically, reporting a message and sleeping a moment.</p>
<p>This highlights the normal usage pattern for an asynchronous context manager in an asyncio program.</p>
<div class="language-python highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #666666">&gt;</span>entering the context manager
within the manager
<span style="color: #666666">&gt;</span>exiting the context manager
</code></pre></div>
<p>You can learn more about async context managers in the tutorial:</p>
<ul>
<li><a href="https://superfastpython.com/asynchronous-context-manager/">Asynchronous Context Managers in Python</a></li>
</ul>
<p>Next, we will explore asynchronous comprehensions.</p>
</div>
</div>
</div>

  <hr>
<div class="md-source-file">
  <small>
    
      最后更新:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2024年9月4日</span>
      
        <br>
        创建日期:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2024年9月4日</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["header.autohide", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.path", "content.tabs.link", "content.code.copy", "content.tooltips", "navigation.indexes", "navigation.prune", "navigation.instant"], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.94c44541.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>